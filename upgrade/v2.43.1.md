# MainNet v2.43.0 -> v2.43.1 Pre-Upgrade Instructions

The following instructions is necessary if you are running a validator node. You need to determine your current oracle service setup, and apply the necessary updates.

>**:exclamation: Run these steps in sequence, do not skip any steps! :exclamation:**

## 1. Check if you are running your oracle service on a different machine

  * Run the following command in your **VALIDATOR NODE**:

    ```
    cat /etc/systemd/system/carbond.service | grep Wants=carbond@oracle.service
    ```

    ### a) If you get the following response: `Wants=carbond@oracle.service`

      * You are running your oracle service and validator on the **SAME** machine. Continue to step [2a) Same Machine](#a-same-machine)

    ### b) If you get no response:

      * You are running your oracle service and validator on a **DIFFERENT** machine. Continue to step [2b) Different Machine](#b-different-machine)

## 2. Setup ssl certs for oracle service

  >:exclamation: Follow either step [2a) Same Machine](#a-same-machine) or step [2b) Different Machine](#b-different-machine) :exclamation:


  * <details>
    <summary>a) Same Machine </summary>
    
    * #### i. Run this in your VALIDATOR NODE

      * Generate ssl configurations, that will be used to authenticate GRPC server.

      *
        ```
        VALIDATOR_NODE_IP_ADDRESS="127.0.0.1"
        ORACLE_SERVICE_NODE_IP_ADDRESS="127.0.0.1"
        CARBON_HOME_PATH="~/.carbon"         # update if necessary
        URL=https://raw.githubusercontent.com/Switcheo/carbon-bootstrap/master/scripts/cert.sh
        bash <(wget -O - $URL) $VALIDATOR_NODE_IP_ADDRESS $ORACLE_SERVICE_NODE_IP_ADDRESS $CARBON_HOME_PATH
        ```
    </details>

  * <details>
    <summary> b) Different Machine </summary>

    * #### i. Run this in your VALIDATOR NODE

      * Generate ssl configurations, that will be used to authenticate GRPC server.

      * >:exclamation: Update the following fields, `VALIDATOR_NODE_IP_ADDRESS` and `ORACLE_SERVICE_NODE_IP_ADDRESS` with the private IP address of each machine. :exclamation:

      *
        ```
        VALIDATOR_NODE_IP_ADDRESS=""         # change to val node ip address
        ORACLE_SERVICE_NODE_IP_ADDRESS=""    # change to oracle service node ip address
        CARBON_HOME_PATH="~/.carbon"         # update if necessary
        URL=https://raw.githubusercontent.com/switcheo/carbon-bootstrap/master/scripts/cert.sh
        bash <(wget -O - $URL) $VALIDATOR_NODE_IP_ADDRESS $ORACLE_SERVICE_NODE_IP_ADDRESS $CARBON_HOME_PATH

        # e.g.
        # VALIDATOR_NODE_IP_ADDRESS="192.168.70.100"
        # ORACLE_SERVICE_NODE_IP_ADDRESS="192.168.70.200"
        # CARBON_HOME_PATH="~/.carbon"
        # URL=https://raw.githubusercontent.com/switcheo/carbon-bootstrap/master/scripts/cert.sh
        # bash <(wget -O - $URL) $VALIDATOR_NODE_IP_ADDRESS $ORACLE_SERVICE_NODE_IP_ADDRESS $CARBON_HOME_PATH

    * #### ii. Run this in your ORACLE NODE

      * Copy ssl certs from validator node to oracle node. Ensure that oracle node is able to access validator node via pub key authentication.

      * >:exclamation: Update fields: `USER` and `VALIDATOR_NODE_IP_ADDRESS`. :exclamation:

      *
        ```
        scp -r USER@VALIDATOR_NODE_IP_ADDRESS:~/.carbon/config/cert ~/.carbon/config/cert

        # e.g.
        # scp -r ubuntu@192.168.70.100:~/.carbon/config/cert ~/.carbon/config/cert
        ```

    * #### iii. Update your oracle service

      * When running your oracle service, you now have to supply an additional flag for the new grpc url, on top of the old one:

      * To check which gRPC IP address your oracle service was previously using, run the following command inside your **ORACLE SERVICE NODE**:

       
      *
        ```
        cat /etc/systemd/system/carbond@.service | grep grpc-url
        ```

      * #### a) If you get no response:

        * <details>
          <summary> Instructions </summary>


          * >:exclamation: Update the following field: `VALIDATOR_NODE_IP_ADDRESS`. :exclamation:

          * Update `ExecStart` in `/etc/systemd/system/carbond@.service` file.

          * 
            ```
            # sudo vim /etc/systemd/system/carbond@.service
            ExecStart=/home/ubuntu/.carbon/cosmovisor/current/bin/carbond %i --oracle-grpc-url VALIDATOR_NODE_IP_ADDRESS:9093

            # e.g.
            # ExecStart=/home/ubuntu/.carbon/cosmovisor/current/bin/carbond %i --oracle-grpc-url 192.168.70.100:9093
            ```
          </details>

      * #### b) If you get the following response:

        * `ExecStart=/home/ubuntu/.carbon/cosmovisor/current/bin/carbond %i --grpc-url GRPC_IP_ADDRESS`

        * Note down `GRPC_IP_ADDRESS`.

        * <details>
          <summary> Instructions </summary>

          * >:exclamation: Update the following fields: `VALIDATOR_NODE_IP_ADDRESS` and `GRPC_IP_ADDRESS`. :exclamation:

          * Update `ExecStart` in `/etc/systemd/system/carbond@.service` file.

          * 
            ```
            # sudo vim /etc/systemd/system/carbond@.service
            ExecStart=/home/ubuntu/.carbon/cosmovisor/current/bin/carbond %i --grpc-url GRPC_IP_ADDRESS:9090 --oracle-grpc-url VALIDATOR_NODE_IP_ADDRESS:9093

            # e.g.
            # ExecStart=/home/ubuntu/.carbon/cosmovisor/current/bin/carbond %i --grpc-url 192.168.70.300:9090 --oracle-grpc-url 192.168.70.100:9093
            ```
          </details>

    * #### iv. Update config changes
      *
        ```
        sudo systemctl daemon-reload
        ```
    </details>

## 3. Download and run v2.43.1 on all nodes

  * If oracle is running on same validator machine, run this on validator node. If oracle and validator is on separate machine, run this both on validator and oracle nodes.

  * #### i. Download and upgrade using the v2.43.1 release bundle.

    * The v2.43.1 release bundle contains v2.43.1 binaries.

    * We will be placing v2.43.1 binaries (carbond) in the cosmovisor/upgrades/v2.43.0 directory.

    *
      ``` 
      VERSION=2.43.1
      MINOR=2.43.0
      NETWORK=mainnet
      FILE=carbond${VERSION}-${NETWORK}.linux-$(dpkg --print-architecture).tar.gz
      wget https://github.com/Switcheo/carbon-bootstrap/releases/download/v${VERSION}/${FILE}
      tar -xvf ${FILE}
      rm ${FILE}
      sudo service carbond stop
      mv carbond ~/.carbon/cosmovisor/upgrades/v${MINOR}/bin/carbond
      sudo service carbond start
      ```

  * #### ii. Restart nodes

    *
      ``` 
      sudo systemctl restart carbond
      ```

  * #### iii. In oracle node, check for errors

    *
      ```
      tail -fn 10 /var/log/carbon/carbond@oracle.*.log

      # Broadcasting Txn with messages....
      ```
